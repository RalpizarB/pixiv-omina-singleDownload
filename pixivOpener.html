<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Pixiv Omina Opener</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <header class="bg-primary text-white text-center py-3">
        <h1>Pixiv Omina Opener</h1>
    </header>

    <main class="container my-5">
        <p>Paste Pixiv links below and send them to Pixiv Omina for downloading.</p>
    </main>
    <textarea id="pixivlinks" class="form-control" rows="5" placeholder="Enter Pixiv links here (one per line)"></textarea>
    
    <div class="mt-3">
        <label for="pageSize" class="form-label">Items per page:</label>
        <input type="number" id="pageSize" class="form-control" value="10" min="1" max="100">
    </div>

    <div class="mt-3">
        <button id="startBtn" class="btn btn-primary" onclick="startProcessing()">Start</button>
        <button id="pauseBtn" class="btn btn-warning" onclick="togglePause()" disabled>Pause</button>
        <button id="continueBtn" class="btn btn-success" onclick="continueNextPage()" disabled>Continue Next Page</button>
    </div>

    <div class="mt-3">
        <div id="status" class="alert alert-info" role="alert">
            Ready to process links
        </div>
    </div>

    <div class="progress mt-3" style="height: 20px;">
        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0"
            aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>

    <script>
        let allLinks = [];
        let currentIndex = 0;
        let isPaused = false;
        let isProcessing = false;
        let pageSize = 10;
        
        // Configuration constants
        const PROTOCOL_WINDOW_CLOSE_DELAY = 500; // Time to wait before closing protocol window
        const LINK_PROCESSING_DELAY = 5000; // Delay between processing links

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function updateProgress(current, total) {
            const progressBar = document.getElementById('progress-bar');
            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
            progressBar.style.width = `${percentage}%`;
            progressBar.setAttribute('aria-valuenow', percentage);
            progressBar.textContent = `${percentage}% (${current}/${total})`;
        }

        function updateButtons() {
            document.getElementById('startBtn').disabled = isProcessing;
            document.getElementById('pauseBtn').disabled = !isProcessing;
            document.getElementById('pauseBtn').textContent = isPaused ? 'Resume' : 'Pause';
            document.getElementById('continueBtn').disabled = isProcessing || currentIndex >= allLinks.length;
        }

        function startProcessing() {
            const textArea = document.getElementById('pixivlinks');
            allLinks = textArea.value.split('\n').filter(link => link.trim() !== '');
            
            if (allLinks.length === 0) {
                updateStatus('No links provided!');
                return;
            }

            pageSize = parseInt(document.getElementById('pageSize').value) || 10;
            currentIndex = 0;
            isPaused = false;
            isProcessing = true;
            updateButtons();
            
            processNextBatch();
        }

        function continueNextPage() {
            if (currentIndex >= allLinks.length) {
                updateStatus('All links processed!');
                return;
            }

            isPaused = false;
            isProcessing = true;
            updateButtons();
            processNextBatch();
        }

        function togglePause() {
            isPaused = !isPaused;
            updateButtons();
            
            if (isPaused) {
                updateStatus(`Paused at ${currentIndex}/${allLinks.length}`);
            } else {
                updateStatus(`Resuming from ${currentIndex}/${allLinks.length}`);
                processNextBatch();
            }
        }

        async function processNextBatch() {
            const endIndex = Math.min(currentIndex + pageSize, allLinks.length);
            
            while (currentIndex < endIndex && !isPaused) {
                const link = allLinks[currentIndex];
                
                if (link.trim()) {
                    let modifiedLink = encodeURI(link.trim());
                    // adds pixiv-omina://create-download?url= before the link
                    modifiedLink = 'pixiv-omina://create-download?url=' + modifiedLink;
                    
                    updateStatus(`Processing ${currentIndex + 1}/${allLinks.length}: ${link.substring(0, 50)}...`);
                    updateProgress(currentIndex + 1, allLinks.length);
                    
                    try {
                        // Create a window to trigger the protocol
                        // Use window.open() with immediate window.focus() to keep focus on current page
                        const win = window.open(modifiedLink, '_blank');
                        
                        // Immediately close the window after protocol handler is triggered
                        if (win) {
                            setTimeout(() => {
                                try {
                                    win.close();
                                } catch (e) {
                                    // Window may already be closed by the protocol handler
                                }
                            }, PROTOCOL_WINDOW_CLOSE_DELAY);
                        }
                        
                        // Keep focus on current window to prevent tab switching
                        window.focus();
                        
                        // Wait before processing next link
                        await new Promise(resolve => setTimeout(resolve, LINK_PROCESSING_DELAY));
                    } catch (error) {
                        console.error(`Error processing link: ${link}`, error);
                        updateStatus(`Error processing link ${currentIndex + 1}: ${error.message}`);
                    }
                }
                
                currentIndex++;
            }

            if (isPaused) {
                updateStatus(`Paused at ${currentIndex}/${allLinks.length}`);
            } else if (currentIndex >= allLinks.length) {
                isProcessing = false;
                updateStatus(`Completed! Processed ${allLinks.length} links.`);
                updateProgress(allLinks.length, allLinks.length);
            } else {
                // Finished current page
                isProcessing = false;
                updateStatus(`Completed page. Processed ${currentIndex}/${allLinks.length} links. Click "Continue Next Page" to process more.`);
            }
            
            updateButtons();
        }
    </script>

    <footer class="bg-dark text-white text-center py-3">
        <p>&copy; Patasoftware</p>
    </footer>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>